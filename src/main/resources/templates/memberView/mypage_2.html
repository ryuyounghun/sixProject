<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org" 
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/css/delivery/deliveryIndex.css">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

<style>

	[v-cloak] {
            display: none;
        }

	a {
		display : inline-block;
	}
</style>
</head>
<body>
	<div id="headerAndSection-wrapper">
		<header>
			<div class="header-container">
				<a href="/" class="header-logo" >
					asd
				</a>
				<a th:href="@{/community/index}" class="header-toAnother" >
					커뮤니티로~
				</a>
				<ui class="header-logMenuList"> <!-- 로그인 및 로그아웃 링크 -->
					<li sec:authorize ="not isAuthenticated">
						<a th:href="@{/member/login}">
							로그인
						</a>
					</li>
					<li sec:authorize="not isAuthenticated">
						<a th:href ="@{/member/join}">
							회원가입
						</a>
					</li>
					<li sec:authorize="isAuthenticated">
						<a th:href ="@{/logout}">
							로그아웃
						</a>
					</li>
					<li sec:authorize="isAuthenticated">
						<a th:href ="@{/member/mypage}">
							회원정보
						</a>
					</li>
				</ui>

			</div>
		</header>
	
		<section>
			<div class="section-container">
				<h1 style="text-align:center;">마이페이지</h1>
				
				<aside>
					<div class="aside-left">

					</div>
				</aside>
				
				<aside>
					<div class="aside-right">

					</div>
				</aside>

				<div class="aside-center">
					<div class="section-center">
						
						
						<div class="d-grid gap-2">
							<a th:href="@{/delivery/inputStore}"><input value = "가게등록 승인" class="btn btn-primary" type="button"></a>
						  	<a th:href="@{/member/myCoupons}"><input value = "내쿠폰확인" class="btn btn-primary" type="button"></a>
						  	<a th:href="@{/delivery/sellerOrderList}"><input value = "레벨 관리" class="btn btn-primary" type="button"></a>
							
							<a class="btn btn-primary" data-bs-toggle="modal" href="#exampleModalToggle" role="button">미니 채팅방 보기</a>
							
						</div>
					
					</div>
				</div>	
			</div>		
		
		</section>

	</div>

	<div class="modal fade" id="exampleModalToggle" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalToggleLabel">Modal 1</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	      	
	      <div class="container" id="app" v-cloak>
		    <div class="row">
		        <div class="col-md-12">
		            <h3>전체 채팅방 리스트</h3>
		        </div>
		    </div>
		    <div class="input-group">
		        <div class="input-group-prepend">
		            <label class="input-group-text">채팅방 검색</label>
		        </div>
		        
		        <input type="text" class="form-control" id="textBox"  v-on:keyup.enter="findAllRoom">
		        <div class="input-group-append">
		            <button class="btn btn-primary" type="button" @click="findAllRoom">검색</button>
		        </div>
		    </div>   
		    
		    <br> 
		    <div class="input-group">
		        
		        <div class="input-group-prepend">
		            <label class="input-group-text">방제목</label>
		        </div>
		        <input type="text" class="form-control" v-model="room_name" v-on:keyup.enter="createRoom">
		        <div class="input-group-append">
		            <button class="btn btn-primary" type="button" @click="createRoom">채팅방 개설</button>
		        </div>
		    </div>
		    <br>
		    <ul class="list-group">
		        <li class="list-group-item list-group-item-action" v-for="item in chatrooms" v-bind:key="item.roomId">
		            <span  v-on:click="enterRoom(item.roomId)">
			            {{item.roomName}}
			            
		            </span>
		            
		            <span >
		            	<input type="button" value = "X" v-on:click="deleteRoom(item.roomId)">
		            	
		            </span>
		        </li>
		    </ul>
		    <div>
				<input type="hidden" id="loginUser" th:value="${#authentication.getPrincipal().getUsername()}">
		    	<input type="hidden" value="" id="enterRoomId">
		    </div>
		</div>
	      
	      </div>
	      <div class="modal-footer">
	        <button class="btn btn-primary" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal">Open second modal</button>
	      </div>
	    </div>
	  </div>
	</div>
	<div class="modal fade" id="exampleModalToggle2" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
	  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalToggleLabel2">Modal 2</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	        
	        <div class="container" id="app2" v-cloak>
			    <div>
			        <h2>{{room.roomName}}</h2>
			    </div>
			    
			    <div class="input-group">
			        <div class="input-group-prepend">
			            <label class="input-group-text">내용</label>
			        </div>
			        <input type="text" class="form-control" v-model="message" v-on:keypress.enter="sendMessage">
			        <div class="input-group-append">
			            <button class="btn btn-primary" type="button" @click="sendMessage">보내기</button>
			        </div>
			    </div>
			    <div id="messageDiv">
				    <ul class="list-group">
				        <li class="list-group-item" v-for="message in messages">
				            {{message.sender}} - {{message.message}}
				            <button v-on:click="reportMessage(message.sender)">신고하기</button>
				        </li>
				    </ul>
			    </div>
			</div>
	        
	      </div>
	      <div class="modal-footer">
	        <button class="btn btn-primary" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">Back to first</button>
	      </div>
	    </div>
	  </div>
	</div>
	


	<footer>
		
	</footer>
	
	<script src="/webjars/vue/2.5.16/dist/vue.min.js"></script>
	<script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
	<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
	<script src="/webjars/stomp-websocket/2.3.3-1/stomp.min.js"></script>
	<script>
		$(document).ready(function() {
			
		});
	
		var sock = new SockJS("/ws/chat");
	    var ws = Stomp.over(sock);
	    var reconnect = 0;
	    var vm = new Vue({
	        el: '#app',
	        data: {
	            room_name : '',
	            chatrooms: [
	            ]
	        },
	        created() {
	            this.findAllRoom();
	        },
	        methods: {
	            findAllRoom: function() {
	            	var params = new URLSearchParams();
	            	var search = $("#textBox").val();
	                params.append("search", search);
	                console.log(search);
	                axios.post('/chat/rooms', params).then(
	                		response => {
	                			console.log(response);
	                			this.chatrooms = response.data;
	                			});
	            },
	            createRoom: function() {
	                if("" === this.room_name) {
	                    alert("방 제목을 입력해 주십시요.");
	                    return;
	                } else {
	                    var params = new URLSearchParams();
	                    params.append("name",this.room_name);
	                    axios.post('/chat/room', params)
	                        .then(
	                            response => {
	                                alert(response.data.roomName+"방 개설에 성공하였습니다.")
	                                this.room_name = '';
	                                this.findAllRoom();
	                            }
	                        )
	                        .catch( response => { alert("채팅방 개설에 실패하였습니다."); } );
	                }
	            },
	            enterRoom: function(roomId) {
	            	$("#enterRoomId").val(roomId);
	                var sender = $("#loginUser").val();
	                if(sender !== "") {
	                    localStorage.setItem('wschat.sender',sender);
	                    localStorage.setItem('wschat.roomId',roomId);
	                    location.href="/chat/room/enter/"+roomId;
	                    //$("#exampleModalToggle").modal("hide");
	                   // $("#exampleModalToggle2").modal("show");
	                }
	            },
	            deleteRoom: function(roomId) {
	            	var params = new URLSearchParams();
	                params.append("roomId", roomId);
	            	axios.post('/chat/deleteRoom', params)
	            	.then(
	            			response => {
	            				
	            		this.findAllRoom();
	            		
	            		});
	            }
	        }
	    });
	    
	    	
	    	// vue.js
		    var vm = new Vue({
		        el: '#app2',
		        data: {
		            roomId: '',
		            room: {},
		            sender: '',
		            message: '',
		            messages: []
		        },
		        created() {
		        	var rId = $("#enterRoomId").val();
		            var loginUser = $("#loginUser").val();
		            this.roomId = rId;
		            	//localStorage.getItem('wschat.roomId');
		            this.sender = loginUser;
		            	//localStorage.getItem('wschat.sender');
		            this.findRoom();
		        },
		        methods: {
		            findRoom: function() {
		                axios.get('/chat/room/'+this.roomId).then(response => { this.room = response.data; });
		            },
		            sendMessage: function() {
		                ws.send("/app/chat/message", {}, JSON.stringify({type:'TALK', roomId:this.roomId, sender:this.sender, message:this.message}));
		                this.message = '';
		            },
		            recvMessage: function(recv) {
		                this.messages.unshift({"type":recv.type,"sender":recv.type=='ENTER'?'[알림]':recv.sender,"message":recv.message})
		            },
		            reportMessage : function(sender) {
		                console.log(sender);
		                console.log($("#reporter").val());
		            }
		        }
		    });
	    
	    function connect() {
	        // pub/sub event
	        ws.connect({}, function(frame) {
	            ws.subscribe("/topic/chat/room/"+vm.$data.roomId, function(message) {
	                var recv = JSON.parse(message.body);
	                vm.recvMessage(recv);
	            });
	            ws.send("/app/chat/message", {}, JSON.stringify({type:'ENTER', roomId:vm.$data.roomId, sender:vm.$data.sender}));
	        }, function(error) {
	            if(reconnect++ <= 5) {
	                setTimeout(function() {
	                    console.log("connection reconnect");
	                    sock = new SockJS("/ws/chat");
	                    ws = Stomp.over(sock);
	                    connect();
	                },10*1000);
	            }
	        });
	    }
	    connect();
	    
	</script>
</body>
</html>