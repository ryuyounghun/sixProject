<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
		xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<title>로그인</title>
	<link rel = "stylesheet" href = "/css/member/login_style.css">
	<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		
		$(document).ready(function() {
			
		});
	
	</script>
</head>
<body>
<!-- 네이버 -->
<ul>
	<li onclick="naverLogin();">
      <!-- 아래와같이 아이디를 꼭 써준다. -->
      <a id="naverIdLogin_loginButton" href="javascript:void(0)">
          <span>네이버 로그인</span>
      </a>
	</li>
	<li onclick="kakaoLogin();">
      <a href="javascript:void(0)">
          <span>카카오 로그인</span>
      </a>
	</li>
</ul>



<!-- 로그인 화면 -->
	    	<div class = "loginContainer">
				<!-- 로그인 화면 제목 -->
				<div class = "loginTitle">
			        <h2>
			        	<em>Group Up</em><br>여러분을 환영합니다.
			        </h2>
		        </div>
		        
		        <!-- 로그인 화면 내용 -->
		        <div class = "loginContent">
		        	<!-- 서버에 보낼 링크, 방식 작성해야 함 -->
		        	<form action = "login" method = "post" id="loginForm">
		        		<fieldset>
		        			<legend>로그인 구역</legend>
		        			<!-- 아이디 -->
		        			<label for = "loginId">아이디</label>
		        			<!-- 아래의 name 속성값은 WebSecurityConfig에서 지정한 usernameParameter의 값과 일치 -->
		        			<input type = "text" id = "loginId" name = "memberId" placeholder = "아이디를 입력하세요.">
		        			<!-- 비밀번호 -->
		        			<label for = "loginPw">비밀번호</label>
		        			<!-- 아래의 name 속성값은 WebSecurityConfig에서 지정한 passwordParameter의 값과 일치 -->
		        			<input type = "password" id = "loginPw" name = "memberPw" placeholder = "비밀번호를 입력하세요.">
		        			<!-- 아이디/비밀번호 찾기 랑 회원가입 이동 링크 부분 -->
		        			<ul>
		        				<li><a href = "#">아이디/비밀번호 찾기</a></li>
		        				<li><a th:href = "@{/member/join}">회원가입</a></li>
		        			</ul>
		        			<!-- 데이터를 서버로 전송하기 위함 -->
		        			<button type = "submit">로그인</button>
		        		</fieldset>
		        	</form>
		        </div>
	        </div>
	    </section>
	    <!-- //section 끝 -->
	    
<!-- 네이버 스크립트 -->
<script src="https://static.nid.naver.com/js/naveridlogin_js_sdk_2.0.2.js" charset="utf-8"></script>

	<script>
	function naverLogin() {

	var naverLogin = new naver.LoginWithNaverId(
			{
				clientId: "s5XCnW0BhF7BUw9Zhr9s", //내 애플리케이션 정보에 cliendId를 입력해줍니다.
				callbackUrl: "http://localhost:1123/member/login", // 내 애플리케이션 API설정의 Callback URL 을 입력해줍니다.
				isPopup: false,
				callbackHandle: true
			}
		);	
	
	naverLogin.init();
		naverLogin.getLoginStatus(function (status) {
			if (status) {
				let email = "N" + naverLogin.user.getEmail(); // 필수로 설정할것을 받아와 아래처럼 조건문을 줍니다.
				let id = naverLogin.user.getId();
	    		let name = naverLogin.user.getName();
				let nickname = naverLogin.user.getNickName();
				let phone = naverLogin.user.getMobile();
				
				console.log(naverLogin.user); 
				console.log(phone);
	            
				$.ajax({
	        		 url : "socialIdCheck",
	        		 type : "post",
	        		 data : {"id" : email},
	        		 success : function(data) {
	        			 console.log(data);
						if(data != ""){
							
							LoginForm(email, id);
							
						} else {
							$.ajax({
		    					url : '/member/naverSignUp',
								type : "post",
		    					data : {"userid" : id,
		    						    "name": name,
		    						    "email": email,
		    						    "nickname" : nickname,
		    						    "phone" : phone},
		    					dataType :"json",
		    					success : function(data){
		    						console.log(data);
		    						if(data != ""){
		    							// 로그인
		    							LoginForm(email, id);		    							
		    						} else {
		    							alert('네이버 회원가입 실패. 일반계정으로 로그인하시기 바랍니다.');
		    						}
		    					}
							});
						}
	        		 
	        		 }
	        	  }); 
			}
		});
			
	}			
	
	
	var testPopUp;
	function openPopUp() {
	    testPopUp= window.open("https://nid.naver.com/nidlogin.logout", "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,width=1,height=1");
	}
	function closePopUp(){
	    testPopUp.close();
	}
	
	function naverLogout() {
		openPopUp();
		setTimeout(function() {
			closePopUp();
			}, 1000);
		
		
	}
	</script>
	
	<!-- 카카오 스크립트 -->
	<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
	<script>
	Kakao.init('6e7c79dc40e0d0df1bb9a7bb0628d68a'); //발급받은 키 중 javascript키를 사용해준다.
	console.log(Kakao.isInitialized()); // sdk초기화여부판단
	//kauth.kakao.com/oauth/authorize?client_id=ff7e45d762a8cd9c3235651811e41a69&redirect_uri=http://localhost:1123/member/kakao&response_type=code
	//카카오로그인
	function kakaoLogin() {
	    Kakao.Auth.login({
	      success: function (response) {
	        Kakao.API.request({
	          url: '/v2/user/me',
	          success: function (response) {
	        	  console.log(response);
	        	  let kakaoid = response.id;
	        	  let email = "K" + response.kakao_account.email;
	        	  let nickname = response.properties.nickname;
	        
	        	  $.ajax({
	        		 url : "socialIdCheck",
	        		 type : "post",
	        		 data : {"id" : email},
	        		 success : function(data) {
	        			 console.log(data);
						if(data != ""){
							
							LoginForm(email, kakaoid);
							
						} else {
							$.ajax({
		    					url : '/member/kakaoSignUp',
								type : "post",
		    					data : {"userid":kakaoid,
		    						    "name":response.properties.nickname,
		    						    "email": email},
		    					dataType :"json",
		    					success : function(data){
		    						console.log(data);
		    						if(data != ""){
		    							// 로그인
		    							LoginForm(email, kakaoid);		    							
		    						} else {
		    							alert('카카오 회원가입 실패. 일반계정으로 로그인하시기 바랍니다.');
		    						}
		    					},
		    					fail: function(request, status, error){
		    		                   alert("code: "+request.status+"\n"+"message: "+request.responseText+"\n"+"error: "+error);
		    		                }
							});
						}
	        		 
	        		 }
	        	  }); 
	        	  
	        	  
	          },
	          fail: function(request, status, error){
                  alert("code: "+request.status+"\n"+"message: "+request.responseText+"\n"+"error: "+error);
               },
	        })
	      },
	      fail: function (error) {
	        console.log(error)
	      },
	    })
	  }
	
	
	function LoginForm(email, id) {
		
		let form = document.getElementById("loginForm");
		
		$("#loginId").val(email);
		$("#loginPw").val(id);
		
		form.submit();
	}
</script>
</body>
</html>