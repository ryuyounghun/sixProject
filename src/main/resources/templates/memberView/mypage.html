<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>마이페이지</title>
<link rel="stylesheet" href="/css/member/mypage.css">
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
 	<!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/webjars/bootstrap/4.3.1/dist/css/bootstrap.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
	

<style>
	[v-cloak] {
            display: none;
        }
        
    table {
    	border : 1px solid black;
    	background-color : aqua;
    }
	
</style>
<script th:inline="javascript">
	$(document).ready(function(){
		// 0928 추가
		let loginUser = $("#loginUser").val();
		$("#hiddenMypage").val(loginUser);
		console.log(typeof memberNumber);
		loadAllReply();	
		$("#btnReply_write").on("click", function() { writeReply(); });
		$("#btnReply_update").hide();
		// 0924 추가
		$("#wishlistBtn").click(function() { wishList(); });
		$("#buyCoupon").hide();
		$("#wishlistStore").hide();
		$("#buyCouponsBtn").click(function() {
			$("#couponList").hide();
			$("#wishlistStore").hide();
			$("#orderList").hide();
			$("#profileModal").hide();
			$("#buyCoupon").show();
			$("#exampleModalLabel").text("쿠폰 구매하기");
			$("#exampleModal").modal("show");
		});
		couponList();
		myPoint();
		$("#myCouponListBtn").click(function() {
			$("#wishlistStore").hide();
			$("#buyCoupon").hide();
			$("#orderList").hide();
			$("#profileModal").hide();
			$("#couponList").show();
			$("#exampleModalLabel").text("MyCoupon List");
			$("#exampleModal").modal("show");
		});
		
		// 0925 추가
		$("#buyCouponsBtn").hide();
		$("#myCouponListBtn").hide();
		$("#reviewModal").hide();
		$("#sellerPageBtn").hide();
		$("#updateMemberInfoBtn").hide();
		$("#profileBtn").hide();
		showMenuList();
		$("#orderListBtn").click(function() { myOrderList(); });
		myReviews();
		
		// 0927 추가 
		$("#sellerPageBtn").click(function() { location.href="/delivery/sellerPage"; });
	
		// 0928 추가
		mypageImage();
		
		$("#profileBtn").click(function() { profileImage(); })
	});
	
	// 0928 추가
	function profileImage() {
		$("#couponList").hide();
		$("#buyCoupon").hide();
		$("#orderList").hide();
		$("#wishlistStore").hide();
		$("#profileModal").show();
		
		$("#exampleModalLabel").text("프로필사진");
		
		$("#exampleModal").modal("show");
	}
	
	
	// 0928 추가
	function mypageImage() {
		let memberNum = getParameterByName('num');
		
		$.ajax({
			url : "mypageImage",
			type : "get",
			data : {"memberNum" : memberNum},
			success : function(data) {
				console.log(data.savedFile);
				let htmlStr = "";
				
				if(data.savedFile != null) {
					htmlStr += "<img src='memberDisplay?num=" + memberNum + "' width='100px'>";
				} else if (data.savedFile == null){
					htmlStr += "<img src='/images/rabbit.jpg' width='100px'>";
				}
				$("#mainImage").html(htmlStr);
			}
		})
		
		
	}
	
	function getParameterByName(name) {
		  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		  var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		  results = regex.exec(location.search);
		  return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
	
	// 0925 추가
	function showMenuList() {
		let memberNum = getParameterByName('num');
		let loginMember = $("#loginMember").val();
		console.log(memberNum);
		console.log(loginMember);
		if(memberNum == loginMember) {
			$("#buyCouponsBtn").show();
			$("#myCouponListBtn").show();
			$("#sellerPageBtn").show();
			$("#updateMemberInfoBtn").show();
			$("#profileBtn").show();
		} 
		
	}
	
	function myOrderList() {
		$("#couponList").hide();
		$("#buyCoupon").hide();
		$("#wishlistStore").hide();
		$("#profileModal").hide();
		let memberNum = getParameterByName('num');
		
		$.ajax({
			url : "myOrderList",
			type : "get",
			data : {"memberNum" : memberNum},
			success : function(data) {
				let htmlStr = "";
				
				if(data == "") {
					htmlStr += "<h1>주문 목록이 없습니다...</h1>";
				} else {
					$.each(data, function(index, item) {
						htmlStr += "<table>";
						htmlStr += "<tr><th>" + item.receiptNum + "</th>";
						htmlStr += "<th>" + item.totalAmount + "</th>";
						htmlStr += "<th><input onclick='writeReview(" + item.storeNum + "," + item.receiptNum + ")' type='button' value='리뷰쓰기'></th></tr>";
						htmlStr += "<tr><th>" + item.orderHistory + "</th></tr>";
						htmlStr += "</table>";
					});
				}
				
				$("#orderList").html(htmlStr);
				$("#exampleModalLabel").text("주문목록");
				$("#orderList").show();
				$("#exampleModal").modal("show");
				
			}
		});
	}
	
	// 0925 추가
	function writeReview(storeNum, receiptNum) {
		$("#hiddenStoreNum").val(storeNum);
		$("#hiddenReceiptNum").val(receiptNum);
		
		endReview(receiptNum);
	}
	
	// 0925 추가
	function endReview(receiptNum) {
		
		$.ajax({
			url : "/delivery/checkReview",
			type : "get",
			data : {"receiptNum" : receiptNum},
			success : function(data) {
				if(data == "") {
					$("#orderList").hide();
					$("#reviewModal").show();
				} else {
					alert("이미 리뷰 한 주문입니다.");
				}
			}
		});
	}
	
	// 0925 추가
	function myReviews() {
		let memberNum = getParameterByName('num');
		
		
		$.ajax({
			url : "myReviews",
			type : "get",
			data : {"memberNum" : memberNum},
			success : function(data) {
				console.log(data);
				let htmlStr = "";
				$.each(data, function(index, item) {
					htmlStr += "<table>";
					htmlStr += "<tr><th>" + item.nickname + "</th>";
					htmlStr += "<th> ★" + item.rating + "</th></tr>";
					htmlStr += "<tr><th colspan='2'>" + item.orderHistory + "</th></tr>";
					htmlStr += "<tr><th colspan='2'>" + item.reviewContent + "</th></tr>";
					htmlStr += "</table>";
				});				
				$("#myReviewList").html(htmlStr);
			}
		});
	}
	
	
	// 0924 추가
	function wishList() {
		$("#couponList").hide();
		$("#buyCoupon").hide();
		$("#profileModal").hide();
		$("#orderList").hide();
		$("#wishlistStore").show();
		let memberNum = getParameterByName('num');
		
		$.ajax({
			url : "lookWishList",
			type : "get",
			data : {"memberNum" : memberNum},
			success : function(data) {
				console.log(data);
				
				/* <![CDATA[ */
				let htmlStr = "";
				
				var goRead = [[@{/delivery/read}]];
				
				$.each(data, function(index, item) {
					htmlStr += "<table border='1' class='menuTable'>";
					htmlStr += "<tr>"; 
					htmlStr += "<td><img src='storeDisplay?num=" + item.storeNum + "' width='80px;'></td>"; 
					htmlStr += "<td class='nameTd'><a href='" + goRead + "?num=" + item.storeNum + "'>" + item.storeName + "</a></td>";
					htmlStr += "<td> ★ " + item.rating + "</td>";
					htmlStr += "<td> ♥ " + item.wishlist + "</td>";
					htmlStr += "</tr>";
					htmlStr += "</table>"
				});
				$("#exampleModalLabel").text("찜리스트");
				$("#wishlistStore").html(htmlStr);
				$("#exampleModal").modal("show");
				/* ]]> */
			}
		});
	}
	
	// 0924 추가
	function buyCoupon(couponNum) {
		
		$.ajax({
			url : "/master/buyOneCoupon",
			type : "get",
			data : {"couponNum" : couponNum},
			success : function(data) {
				alert("상품을 구입하셨습니다.");
				couponList();
			}
		});
	}
	
	// 0924 추가
	function couponList() {
		
		$.ajax({
			url : "myCouponList",
			type : "get",
			success : function(data) {
				console.log(data);
				
				let htmlStr = "";
				if(data == "") {
					htmlStr += "<h1>남은 쿠폰이 없습니다....</h1>";
				} else {
					
					$.each(data, function(index, item) {
						htmlStr += "<table>";
						htmlStr += "<tr><th>" + item.couponName + "</th></tr>";
						htmlStr += "<tr><th>" + item.couponPoint + "</th></tr>";
						htmlStr += "<tr><th><input type='button' value='사용' onclick='useCoupon(" + item.myCouponNum + ")'></th></tr>";
						htmlStr += "</table>";
					});
				}
				
				$("#couponList").html(htmlStr);
			}
		});
	}
	
	
	// 0924 추가
	function useCoupon(myCouponNum) {
		
		$.ajax({
			url : "useCoupon",
			type : "get",
			data : {"myCouponNum" : myCouponNum},
			success : function(data) {
				alert("쿠폰을 사용하였습니다.");
				console.log(data);
				if(data == "") {
					$("#couponList").text("남은 쿠폰이 없습니다....");
				}
				
				couponList();
				myPoint();
			}
		});
	}
	
	// 0924 추가
	function myPoint() {
		let memberNum = getParameterByName('num');
		$.ajax({
			url : "myPoint",
			type : "get",
			data : {"memberNum" : memberNum},
			success : function(data) {
				console.log(data.memberPoint);
				
				let htmlStr = "<h5>잔여 포인트</h5>";
				htmlStr += "<h5>" + data.memberPoint + "point</h5>";
				
				$("#point").html(htmlStr);
			}
		});
	}
	
	
	function loadAllReply() {
		 let memberNum = getParameterByName('num');
	  
		$.ajax({
			url:"loadAllReply",	// 콘트롤러에서 메핑이랑 일치해야 함 (굳이 자바스크립트 함수이름과 같을 필요 없음)
			type:"get",
			data: {"memberNum": memberNum},	// ""=> 콘트롤러 파라미터로 넘겨줌(이름 콘트롤러랑 똑같이)
			success: function(data){	// data는 콘트롤러에서 return 값으로 가져온거(list 결과들, 이름을 어떻게 가져와도 자유!)
				let htmlStr = "<table>";
				$.each(data, function(index, value){	//data는 리스트니까 반복문 each로 돌려줘야함 그래서 index 얼마나 있는지 볼라고 필요함
					htmlStr += "<tr>";
					htmlStr += "<td>" + value.content + "</td>";
					htmlStr += "<td>" + value.nickname + "</td>";
					htmlStr += "<td>" + value.inputdate + "</td>";
					htmlStr += "</tr>";	
				});
				htmlStr += "</table>";
					
				$("#reList").html(htmlStr);
				}
		});
	}
	
	function writeReply(){
	      let content = $("#content").val();
	      
	      let memberNum = getParameterByName('num');
	      console.log("dlkj");
	      $.ajax({
	         url: "writeReply",
	         type: "post",
	         data: {"content" : content, "memberNum" : memberNum},
	         success: function(){
	            // 페이지 새로고침
	            $("#content").val(""); 		// 댓글창에 내용을 없애버림
	            loadAllReply();				// 페이지 새로고침 -> 댓글 목록만 가져와서 새로뿌리기
	         }
	      
	      });
	   }



	
</script>
</head>
<body>
	<div id="headerAndSection-wrapper">
		<header>
			<div class="header-container">
				<a href="/" class="header-logo" >
					ㄹ고
				</a>
				<a th:href="@{/delivery/index}" class="header-toAnother" >
					배달로~
				</a>
				
				<ui class="header-logMenuList"> <!-- 로그인 및 로그아웃 링크 -->
					<li sec:authorize ="not isAuthenticated">
						<a th:href="@{/memberView/login}">
							로그인
						</a>
					</li>
					<li sec:authorize="not isAuthenticated">
						<a th:href ="@{/memberView/join}">
							회원가입
						</a>
					</li>
					<li sec:authorize="isAuthenticated">
						<a th:href ="@{/logout}">
							로그아웃
						</a>
					</li>
				</ui>

			</div>
		</header>
	
		<section>
			<div class= "section-container">
				<aside>
					<div class="aside-left">
						<div id="mainImage">
							
						</div>
						<h2 th:text="${memberPage.memberName}"></h2>
						<div class = "expBar">
							<span class = "expBar"></span>
						</div>
							
						<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
						  채팅걸기
						</button>
						
						<div id="point"></div>
						
						<div id="menuList">
							<ul>
								<li id="wishlistBtn">
									찜리스트
								</li>
								<li id="orderListBtn">
									주문 리스트
								</li>
								<li id="buyCouponsBtn">
									쿠폰 구매
								</li>
								<li id="myCouponListBtn">
									내 쿠폰
								</li>
								<li id="sellerPageBtn">
									판매자 페이지
								</li>
								<li id="updateMemberInfoBtn">
									<a th:href ="@{/member/updateInfo}">
										회원정보 수정
									</a>
								</li>
								<li id="profileBtn">
									프로필 변경
								</li>
							</ul>
						</div>	
						
						
					</div>
				</aside>
				
				<!-- <aside>
					<div class="aside-right">

					</div>
				</aside> -->

			<div class="aside-center">
				<div class="section-center">
				
				<div id="mainMypage">
					
					
					
					
					<div class="partyJoinOut">
						<div style="overflow:scroll; height:360px; width:300px;">
							<span>리뷰 모음</span>
							<div id="myReviewList" ></div>
						
						</div> 
					</div><!-- partyJoinOut 부분 끝 -->
					<div class="partyJoinOut2">
						<div class = "guestbook">
							<span class = "guestbookTitle">방명록</span>
							
							<div id="reList" style="overflow:scroll; height:300px; width:650px;">
							</div>
						
							<div>
								<input th:object = "${guestbook}" th:onclick = "${content}" name="content" id="content">
								
								<button id = "btnReply_write">작성하기</button>
								<!-- <input type = "button" value = "수정하기" id = "btnReply_update"> -->
								<input type = "hidden" id = "loginUser" th:value = "${#authentication.getPrincipal().getUsername()}">
							</div>
						</div><!-- guestbook 부분 끝 -->
					</div>	<!-- partyJoinOut2 부분 끝 -->
				</div><!-- mainMypage 끝 -->
				
				
				
				</div><!-- section-center  -->
			</div><!--aside-center  -->
		</div>
		</section>
		
		
		<!-- Modal -->
		<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="staticBackdropLabel">채팅</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		      </div>
		      <div class="modal-body">
		        <div class="container" id="app" v-cloak>
				    <div>
				        <h2>{{room.roomName}}</h2>
				    </div>
				    
				    <div class="input-group">
				        <div class="input-group-prepend">
				            <label class="input-group-text">내용</label>
				        </div>
				        <input type="text" class="form-control" v-model="message" v-on:keypress.enter="sendMessage">
				        <div class="input-group-append">
				            <button class="btn btn-primary" type="button" @click="sendMessage">보내기</button>
				        </div>
				    </div>
				    <div id="messageDiv">
					    <ul class="list-group">
					        <li class="list-group-item" v-for="message in messages">
					            {{message.sender}} - {{message.message}}
					            <button  v-on:click="reportMessage(message.sender, message.message)">신고하기</button>
					        </li>
					    </ul>
				    </div>
				    <div>
				    	<input type="hidden" id="loginUser" th:value="${#authentication.getPrincipal().getUsername()}">
				    	<input type="hidden" id="memberRoomId" th:value="${memberPage.roomId}">
				    	<input type="hidden" id="loginMember" th:value="${member.memberNum}">
				   		<input type="hidden" th:value="${#authentication.getPrincipal().getUsername()}" name="reporter" id="reporter">
				    </div>
				</div>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		        <button type="button" class="btn btn-primary">Understood</button>
		      </div>
		    </div>
		  </div>
		</div>
		
		
		
		<!-- Modal -->
		<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		      </div>
		      <div class="modal-body">
		        <div id="wishlistStore"></div>
		        <div id="buyCoupon">
		        <h2>쿠폰 구매하기</h2>
						<div class = "couponCenter">
							<table th:each="cList : ${cList}">
								<tr>
									<th th:text="${cList.couponNum}"></th>
								</tr>
								<tr>
									<th th:text="${cList.couponName}"></th>
								</tr>
								<tr>
									<th th:text="|${cList.couponPoint}원|"></th>
								</tr>
								<tr>
									<th>
										<input type="button" th:onclick="|buyCoupon(${cList.couponNum})|" value="button">
									</th>
								</tr>
							</table>
						</div><!-- couponCenter 부분 끝 -->
		        </div><!-- buyCoupon 끝 -->
		        <div id="couponList"></div>
		        <div id="orderList"></div>
		        
		        <div id="reviewModal">
		        	<form action="myCompleteOrderList" method="post">
				        <div id="starPoint">
				        	<label for="oneStar">1</label>
				        	<input type="radio" id="oneStar" value="1" name="rating">
				        	<label for="twoStar">2</label>
				        	<input type="radio" id="twoStar" value="2" name="rating"> 
				        	<label for="threeStar">3</label>
				        	<input type="radio" id="threeStar" value="3" name="rating">
				        	<label for="fourStar">4</label>
				        	<input type="radio" id="fourStar" value="4" name="rating">
				        	<label for="fiveStar">5</label>
				        	<input type="radio" id="fiveStar" value="5" name="rating">
				        </div>
				        <input type="hidden" id="hiddenStoreNum" value="" name="storeNum">
				        <input type="hidden" id="hiddenReceiptNum" value="" name="receiptNum">
				    	<div class="mb-3">
				        	<label for="message-text" class="col-form-label">Content</label>
				            <textarea class="form-control" id="message-text" name="reviewContent"></textarea>
				        </div>
					    <div class="modal-footer">
					    	<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					    	<button type="submit" class="btn btn-primary">리뷰남기기</button>
					    </div>
	        		</form>
		        </div>
		        <div id="profileModal">
		        	<form action="updateImage" method="post" enctype="multipart/form-data">
		        		<input type="file" name="file" id="uploadFile">
		        		<input type="hidden" value="" id="hiddenMypage" name="memberId">
		        		<input type="submit" value="업로드" id="uploadBtn">
		        	</form>
		        </div>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		        <button type="button" class="btn btn-primary">Save changes</button>
		      </div>
		    </div>
		  </div>
		</div>
		
	</div>

	<footer>
		
	</footer>
<script>
    var input = document.getElementById("content");

    input.addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("btnReply_write").click();
      }
    });
</script>
<script src="/webjars/vue/2.5.16/dist/vue.min.js"></script>
<script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.3-1/stomp.min.js"></script>
<script>
    //alert(document.title);
    // websocket & stomp initialize
    var sock = new SockJS("/ws/chat");
    var ws = Stomp.over(sock);
    var reconnect = 0;
    // vue.js
    var vm = new Vue({
        el: '#app',
        data: {
            roomId: '',
            room: {},
            sender: '',
            message: '',
            messages: []
        },
        created() {
        	var rId = $("#memberRoomId").val();
            var loginUser = $("#loginUser").val();
            this.roomId = rId;
            this.sender = loginUser;
            	//localStorage.getItem('wschat.sender');
            this.findRoom();
        },
        methods: {
            findRoom: function() {
                axios.get('/chat/room/'+this.roomId).then(response => { this.room = response.data; });
            },
            sendMessage: function() {
                ws.send("/app/chat/message", {}, JSON.stringify({type:'TALK', roomId:this.roomId, sender:this.sender, message:this.message}));
                this.message = '';
            },
            recvMessage: function(recv) {
                this.messages.unshift({"type":recv.type,"sender":recv.type=='ENTER'?'[알림]':recv.sender,"message":recv.message})
            },
            reportMessage : function(sender, message) {
                console.log(sender);
                console.log(message);
                let reporter = $("#reporter").val();
                console.log(reporter);
                ws.send("/app/chat/report", {}, JSON.stringify({type:'TALK', roomId:this.roomId, sender:this.sender, message:message, reporter:reporter}));
                this.message='';
            }
        }
    });

    function connect() {
        // pub/sub event
        ws.connect({}, function(frame) {
            ws.subscribe("/topic/chat/room/"+vm.$data.roomId, function(message) {
                var recv = JSON.parse(message.body);
                vm.recvMessage(recv);
            });
            ws.send("/app/chat/message", {}, JSON.stringify({type:'ENTER', roomId:vm.$data.roomId, sender:vm.$data.sender}));
        }, function(error) {
            if(reconnect++ <= 5) {
                setTimeout(function() {
                    console.log("connection reconnect");
                    sock = new SockJS("/ws/chat");
                    ws = Stomp.over(sock);
                    connect();
                },10*1000);
            }
        });
    }
    connect();
</script>

</body>
</html>