<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<title>마이페이지(수정 중)</title>
<link rel="stylesheet" href="/css/member/mypage.css">
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<style>
/* 	table {
		border : 1px solid black;
		background-color : aqua;
		width:100%;
		margin:10px;
	}	 */
	
</style>
<script>
	$(document).ready(function(){
		
		$("#btnReply_write").on("click", function() { writeReply(); });
		$("#btnReply_update").hide();
		loadAllReply();	
	});
	
	
	function getParameterByName(name) {
		  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		  var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		  results = regex.exec(location.search);
		  return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
	
	function loadAllReply(){
		 let memberNum = getParameterByName('num');
      
		$.ajax({
			url:"loadAllReply",	// 콘트롤러에서 메핑이랑 일치해야 함 (굳이 자바스크립트 함수이름과 같을 필요 없음)
			type:"get",
			data: {"memberNum": memberNum},	// ""=> 콘트롤러 파라미터로 넘겨줌(이름 콘트롤러랑 똑같이)
			success: function(data){	// data는 콘트롤러에서 return 값으로 가져온거(list 결과들, 이름을 어떻게 가져와도 자유!)
				let htmlStr = "<table>";
				$.each(data, function(index, value){	//data는 리스트니까 반복문 each로 돌려줘야함 그래서 index 얼마나 있는지 볼라고 필요함
					htmlStr += "<tr>";
					htmlStr += "<td>" + value.content + "</td>";
					htmlStr += "<td>" + value.nickname + "</td>";
					htmlStr += "<td>" + value.inputdate + "</td>";
					htmlStr += "</tr>";	
				});
				
				htmlStr += "</table>";
					
				/* htmlStr += "<a href = 'javascript:loadAllReply();'>댓글 새로고침</a>" */
					
				$("#reList").html(htmlStr);
					
				}
		});
		
	}
	
	function writeReply(){
	      let content = $("#content").val();
	      
	      let memberNum = getParameterByName('num');
	      console.log("dlkj");
	      $.ajax({
	         url: "writeReply",
	         type: "post",
	         data: {"content" : content, "memberNum" : memberNum},
	         success: function(){
	            // 페이지 새로고침
	            $("#content").val(""); 		// 댓글창에 내용을 없애버림
	            loadAllReply();				// 페이지 새로고침 -> 댓글 목록만 가져와서 새로뿌리기
	         }
	      
	      });
	   }
</script>
</head>
<body>
	<div id="headerAndSection-wrapper">
		<header>
			<div class="header-container">
				<a href="/" class="header-logo" >
					ㄹ고
				</a>
				<a th:href="@{/delivery/index}" class="header-toAnother" >
					배달로~
				</a>
				
				<ui class="header-logMenuList"> <!-- 로그인 및 로그아웃 링크 -->
					<li sec:authorize ="not isAuthenticated">
						<a th:href="@{/memberView/login}">
							로그인
						</a>
					</li>
					<li sec:authorize="not isAuthenticated">
						<a th:href ="@{/memberView/join}">
							회원가입
						</a>
					</li>
					<li sec:authorize="isAuthenticated">
						<a th:href ="@{/logout}">
							로그아웃
						</a>
					</li>
					<li sec:authorize="isAuthenticated">
						<a th:href ="@{/memberView/mypage}">
							회원정보
						</a>
					</li>
				</ui>

			</div>
		</header>
	
		<section>
			<div class= "section-container">
				<aside>
					<div class="aside-left">
						
						<span class = "nameBox" th:object = "${guestbook}" ></span><br>
						<span class = "intro">
						<input type = "text" placeholder="자기소개를 입력해주세요.">
						</span>
						
					</div>
				</aside>
				
				<!-- <aside>
					<div class="aside-right">

					</div>
				</aside> -->

			<div class="aside-center">
				<div class="section-center">
					<div class="mapInfo">
						<label for = "level">레벨</label>
						<label for = "chat">채팅하기
							<a th:href="@{/memberView/login}"></a>
						</label>
						<label for = "store">단골 가게</label>
					</div><!-- mapInfo 부분 끝 -->
					
					<div class = "expBar">
						<span class = "expBar">경험치 바(임시)</span>
					</div>
					
					<div class="partyJoinOut">
						<div>
							<span>참여한 모임</span>
						</div> 
					</div><!-- partyJoinOut 부분 끝 -->
						<div class="partyJoinOut2">
							<div class = "guestbook">
								<span class = "guestbookTitle">방명록</span>
								
							<div id="reList" style="overflow:scroll; height:300px; width:650px;">
							
							
							</div>
							
							<div>
								<input th:object = "${guestbook}" th:onclick = "${content}" name="content" id="content">
								
								<button id = "btnReply_write">작성하기</button>
								<!-- <input type = "button" value = "수정하기" id = "btnReply_update"> -->
								<input type = "hidden" id = "loginUser" th:value = "${#authentication.getPrincipal().getUsername()}">
							</div>
							
							
							</div><!-- guestbook 부분 끝 -->
						</div>	<!-- partyJoinOut2 부분 끝 -->
				</div><!-- section-center  -->
			</div><!--aside-center  -->
		</div>
		</section>

	</div>

	<footer>
		
	</footer>
<script>
    var input = document.getElementById("content");

    input.addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("btnReply_write").click();
      }
    });
</script>
  

</body>
</html>